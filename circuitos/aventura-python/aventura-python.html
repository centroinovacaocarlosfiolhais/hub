<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Game Lab - CICF</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            color: white;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header {
            background: rgba(45, 53, 97, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .session-info {
            color: #b794f4;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #8b5cf6;
            color: white;
        }

        .btn-primary:hover {
            background: #7c3aed;
        }

        .instructions {
            background: rgba(49, 130, 206, 0.2);
            border: 1px solid rgba(49, 130, 206, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .instructions h3 {
            color: #90cdf4;
            margin-bottom: 10px;
        }

        .instructions p {
            margin: 5px 0;
        }

        .main-content {
            flex: 1;
            display: flex;
            gap: 15px;
            min-height: 0;
        }

        .game-panel, .code-panel {
            flex: 1;
            background: rgba(45, 53, 97, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }

        #gameCanvas {
            border: 2px solid rgba(138, 43, 226, 0.5);
            border-radius: 8px;
            image-rendering: pixelated;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.85em;
            color: #cbd5e0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        #codeEditor {
            flex: 1;
            background: #1a202c;
            color: #48bb78;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            resize: none;
            outline: none;
        }

        #codeEditor::placeholder {
            color: #4a5568;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-run {
            flex: 1;
            background: #48bb78;
            color: white;
        }

        .btn-run:hover {
            background: #38a169;
        }

        .btn-run:disabled {
            background: #4a5568;
            cursor: not-allowed;
        }

        .btn-reset {
            background: #ed8936;
            color: white;
        }

        .btn-reset:hover {
            background: #dd6b20;
        }

        /* Password Section */
        .password-section {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .password-input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.5);
            border-radius: 6px;
            color: white;
            font-family: monospace;
            text-transform: uppercase;
        }

        .btn-password {
            background: #f59e0b;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-password:hover {
            background: #d97706;
        }

        /* Victory Modal */
        .victory-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s;
        }

        .victory-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .victory-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.5s;
            max-width: 500px;
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .victory-emoji {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .victory-title {
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .victory-message {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .victory-stats {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .victory-stat {
            font-size: 1.1em;
            color: #ffd700;
            margin: 10px 0;
        }

        .btn-celebrate {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s;
        }

        .btn-celebrate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.6);
        }

        .console {
            background: #1a202c;
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            height: 120px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .console-header {
            color: #718096;
            font-size: 0.75em;
            margin-bottom: 5px;
        }

        .console-line {
            color: #e2e8f0;
            margin: 2px 0;
        }

        .progress-bar {
            background: rgba(45, 53, 97, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .progress-bars {
            display: flex;
            gap: 5px;
        }

        .progress-segment {
            width: 60px;
            height: 8px;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <div class="title">
                    <span>üèÜ</span>
                    <span>Aventura Python - CICF</span>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="toggleInstructions()">
                        üìñ <span id="btnText">Ocultar</span>
                    </button>
                    <button class="btn btn-primary" onclick="openTeacherGuide()">
                        üë®‚Äçüè´ Gui√£o Professor
                    </button>
                </div>
            </div>
            <div class="header-bottom">
                <span class="session-info" id="sessionInfo"></span>
                <span id="levelInfo"></span>
            </div>
        </div>

        <!-- Instructions -->
        <div class="instructions" id="instructions">
            <h3 id="levelTitle"></h3>
            <p>üéØ <span id="objective"></span></p>
            <p style="color: #90cdf4; font-size: 0.9em;">üí° Dica: <span id="hint"></span></p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Game Panel -->
            <div class="game-panel">
                <div class="panel-title">üéÆ Mundo do Jogo</div>
                <div class="canvas-wrapper">
                    <canvas id="gameCanvas"></canvas>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ff006e; border-radius: 50%;"></div>
                        <span>Her√≥i</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #ffd700;"></div>
                        <span>Tesouro</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #00d9ff; border-radius: 50%;"></div>
                        <span>Gema</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: #2d3561;"></div>
                        <span>Parede</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 1.2em;">üîë</span>
                        <span>Chave</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-size: 1.2em;">üö™</span>
                        <span>Porta</span>
                    </div>
                </div>
            </div>

            <!-- Code Panel -->
            <div class="code-panel">
                <div class="panel-title">üíª Editor Python</div>
                <textarea id="codeEditor" placeholder="# Escreve o teu c√≥digo Python aqui
# Exemplo:
# heroi.direita()
# heroi.baixo()
# heroi.coletar()" spellcheck="false"></textarea>
                
                <div class="button-row">
                    <button class="btn btn-run" onclick="runCode()" id="runBtn">
                        ‚ñ∂Ô∏è Executar
                    </button>
                    <button class="btn btn-reset" onclick="resetLevel()">
                        üîÑ Reset
                    </button>
                </div>

                <div class="console">
                    <div class="console-header">üìã Console de Sa√≠da:</div>
                    <div id="consoleOutput"></div>
                </div>

                <!-- Password Section -->
                <div class="password-section">
                    <input 
                        type="text" 
                        id="passwordInput" 
                        class="password-input" 
                        placeholder="A carregar..."
                        maxlength="15"
                    >
                    <button class="btn-password" onclick="checkLevelPassword()">
                        üîì Ir para N√≠vel
                    </button>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-info">
                <span id="progressText"></span>
                <div class="progress-bars" id="progressBars"></div>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div class="victory-overlay" id="victoryOverlay">
        <div class="victory-modal">
            <div class="victory-emoji">üèÜ</div>
            <h1 class="victory-title">INCR√çVEL!</h1>
            <p class="victory-message">
                Completaste todos os desafios!<br>
                √âs um verdadeiro mestre da programa√ß√£o! üéâ
            </p>
            <div class="victory-stats">
                <div class="victory-stat">‚ú® 9 n√≠veis conclu√≠dos</div>
                <div class="victory-stat">üêç Python dominado</div>
                <div class="victory-stat">üíé Todas as gemas coletadas</div>
            </div>
            <button class="btn-celebrate" onclick="closeVictoryModal()">
                üöÄ Continuar a Explorar
            </button>
        </div>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998;"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // üéÆ ESTADO DO JOGO
        let currentSession = 0;
        let currentLevel = 0;
        let playerPos = { x: 1, y: 1 };
        let collected = [];
        let hasKey = false;
        let isRunning = false;
        let showInstr = true;

        // üìö ESTRUTURA DAS SESS√ïES
        const sessions = [
            {
                name: "Sess√£o 1: Movimento B√°sico",
                description: "Aprende a mover o her√≥i com comandos simples",
                levels: [
                    {
                        title: "Primeiro Passo",
                        objective: "Move o her√≥i 3 passos para a direita para chegar ao tesouro",
                        hint: "usa: heroi.direita()",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 0, 0, 3, 0, 1],
                            [1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "INICIO2025",
                        solution: "heroi.direita()\nheroi.direita()\nheroi.direita()"
                    },
                    {
                        title: "Caminho em L",
                        objective: "Move o her√≥i em forma de L para pegar a chave",
                        hint: "combina: heroi.direita() e heroi.baixo()",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 0, 0, 1, 1, 1],
                            [1, 1, 1, 0, 1, 1, 1],
                            [1, 1, 1, 3, 1, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "CURVA2025",
                        solution: "heroi.direita()\nheroi.direita()\nheroi.baixo()\nheroi.baixo()"
                    },
                    {
                        title: "Usa Ciclos",
                        objective: "Usa um ciclo for para mover 5 passos",
                        hint: "for i in range(5):",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 0, 0, 0, 0, 3, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "LOOP2025",
                        solution: "for i in range(5):\n    heroi.direita()"
                    }
                ]
            },
            {
                name: "Sess√£o 2: Ciclos e Repeti√ß√£o",
                description: "Domina ciclos for e while",
                levels: [
                    {
                        title: "Padr√£o em Escada",
                        objective: "Cria um padr√£o: direita, baixo, direita, baixo",
                        hint: "usa um ciclo for com m√∫ltiplos comandos",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 0, 1, 1, 1, 1],
                            [1, 1, 0, 0, 1, 1, 1],
                            [1, 1, 1, 0, 0, 1, 1],
                            [1, 1, 1, 1, 3, 1, 1],
                            [1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "ESCADA2025",
                        solution: "for i in range(2):\n    heroi.direita()\n    heroi.baixo()\nheroi.direita()\nheroi.baixo()"
                    },
                    {
                        title: "Coleta Todas as Gemas",
                        objective: "Percorre o corredor, coleta 4 gemas e chega ao tesouro",
                        hint: "usa range() para repetir",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 2, 2, 2, 2, 3, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        targetCollect: 4,
                        solution: "for i in range(4):\n    heroi.direita()\n    heroi.coletar()\nheroi.direita()"
                    }
                ]
            },
            {
                name: "Sess√£o 3: Condi√ß√µes e Decis√µes",
                description: "Aprende if/else e condi√ß√µes",
                levels: [
                    {
                        title: "Decis√£o no Caminho",
                        objective: "Verifica se h√° tesouro √† direita antes de mover",
                        hint: "usa: if heroi.ver_direita() == 'tesouro':",
                        map: [
                            [1, 1, 1, 1, 1],
                            [1, 0, 3, 0, 1],
                            [1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "DECISAO2025",
                        solution: "if heroi.ver_direita() == 'tesouro':\n    heroi.direita()"
                    },
                    {
                        title: "Chave e Porta",
                        objective: "Coleta a chave, navega at√© √† porta e abre-a para chegar ao tesouro",
                        hint: "usa heroi.pegar_chave() e heroi.abrir_porta(). Verifica o caminho com ver_direita() e ver_baixo()",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 4, 0, 1, 0, 1],
                            [1, 0, 1, 0, 1, 0, 1],
                            [1, 0, 0, 0, 5, 0, 1],
                            [1, 1, 1, 1, 0, 3, 1],
                            [1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        needsKey: true,
                        password: "PORTA2025",
                        solution: "# Pegar a chave\nheroi.direita()\nheroi.pegar_chave()\n\n# Navegar at√© √† porta\nheroi.direita()\nheroi.baixo()\nheroi.baixo()\nheroi.direita()\n\n# Abrir porta\nif heroi.tem_chave():\n    heroi.abrir_porta()\n    heroi.direita()\n    heroi.baixo()\n    heroi.direita()"
                    }
                ]
            },
            {
                name: "Sess√£o 4: Fun√ß√µes e Desafios",
                description: "Cria fun√ß√µes reutiliz√°veis",
                levels: [
                    {
                        title: "Cria uma Fun√ß√£o",
                        objective: "Define fun√ß√£o mover_e_coletar() e usa-a 3 vezes",
                        hint: "def mover_e_coletar():",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 2, 2, 2, 3, 1],
                            [1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        password: "FUNCAO2025",
                        targetCollect: 3,
                        solution: "def mover_e_coletar():\n    heroi.direita()\n    heroi.coletar()\n\nfor i in range(3):\n    mover_e_coletar()\nheroi.direita()"
                    },
                    {
                        title: "Desafio Final",
                        objective: "Usa tudo o que aprendeste!",
                        hint: "combina fun√ß√µes, ciclos e condi√ß√µes",
                        map: [
                            [1, 1, 1, 1, 1, 1, 1, 1],
                            [1, 0, 2, 0, 0, 2, 0, 1],
                            [1, 0, 1, 1, 1, 1, 0, 1],
                            [1, 0, 2, 0, 0, 2, 0, 1],
                            [1, 0, 0, 0, 0, 0, 3, 1],
                            [1, 1, 1, 1, 1, 1, 1, 1]
                        ],
                        start: { x: 1, y: 1 },
                        targetCollect: 4,
                        password: "MESTRE2025",
                        solution: "# Linha superior - gemas em (2,1) e (5,1)\nheroi.direita()\nheroi.coletar()\nfor i in range(3):\n    heroi.direita()\nheroi.coletar()\n\n# Descer pela direita\nheroi.direita()\nheroi.baixo()\nheroi.baixo()\n\n# Linha inferior - gemas em (5,3) e (2,3)\nheroi.esquerda()\nheroi.coletar()\nfor i in range(3):\n    heroi.esquerda()\nheroi.coletar()\n\n# Ir para o tesouro em (6,4)\nheroi.esquerda()\nheroi.baixo()\nfor i in range(5):\n    heroi.direita()"
                    }
                ]
            }
        ];

        // üé® FUN√á√ïES DE RENDERIZA√á√ÉO
        function drawGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const level = sessions[currentSession].levels[currentLevel];
            const cellSize = 50;
            
            canvas.width = level.map[0].length * cellSize;
            canvas.height = level.map.length * cellSize;

            // Background
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Desenhar mapa
            level.map.forEach((row, y) => {
                row.forEach((cell, x) => {
                    const posX = x * cellSize;
                    const posY = y * cellSize;

                    // Sombra
                    ctx.fillStyle = 'rgba(0,0,0,0.3)';
                    ctx.fillRect(posX + 2, posY + 2, cellSize - 4, cellSize - 4);

                    // C√©lula
                    if (cell === 1) {
                        ctx.fillStyle = '#2d3561';
                    } else {
                        ctx.fillStyle = '#0f0f1e';
                    }
                    ctx.fillRect(posX, posY, cellSize - 2, cellSize - 2);

                    // Gema
                    if (cell === 2 && !collected.includes(`${x},${y}`)) {
                        ctx.fillStyle = '#00d9ff';
                        ctx.beginPath();
                        ctx.arc(posX + cellSize/2, posY + cellSize/2, 10, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = 'rgba(255,255,255,0.6)';
                        ctx.beginPath();
                        ctx.arc(posX + cellSize/2 - 3, posY + cellSize/2 - 3, 4, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Tesouro
                    if (cell === 3) {
                        ctx.fillStyle = '#ffd700';
                        ctx.fillRect(posX + 12, posY + 12, cellSize - 24, cellSize - 24);
                        ctx.fillStyle = '#ffed4e';
                        ctx.fillRect(posX + 16, posY + 16, cellSize - 32, cellSize - 32);
                    }

                    // Chave
                    if (cell === 4 && !hasKey) {
                        ctx.fillStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(posX + cellSize/2, posY + cellSize/2 - 5, 8, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillRect(posX + cellSize/2 - 2, posY + cellSize/2 - 5, 4, 15);
                        ctx.fillRect(posX + cellSize/2 - 2, posY + cellSize/2 + 5, 8, 3);
                    }

                    // Porta
                    if (cell === 5) {
                        if (hasKey) {
                            // Porta aberta (verde)
                            ctx.fillStyle = '#48bb78';
                        } else {
                            // Porta fechada (vermelha)
                            ctx.fillStyle = '#f56565';
                        }
                        ctx.fillRect(posX + 10, posY + 8, cellSize - 20, cellSize - 16);
                        ctx.fillStyle = 'rgba(0,0,0,0.3)';
                        ctx.fillRect(posX + 15, posY + 12, cellSize - 30, cellSize - 24);
                        
                        // Ma√ßaneta
                        ctx.fillStyle = '#ffd700';
                        ctx.beginPath();
                        ctx.arc(posX + cellSize - 18, posY + cellSize/2, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            });

            // Jogador
            const playerX = playerPos.x * cellSize + cellSize/2;
            const playerY = playerPos.y * cellSize + cellSize/2;
            
            ctx.fillStyle = '#ff006e';
            ctx.beginPath();
            ctx.arc(playerX, playerY, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Olhos
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(playerX - 5, playerY - 3, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(playerX + 5, playerY - 3, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(playerX - 5, playerY - 3, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(playerX + 5, playerY - 3, 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function updateUI() {
            const session = sessions[currentSession];
            const level = session.levels[currentLevel];

            document.getElementById('sessionInfo').textContent = session.name;
            document.getElementById('levelInfo').textContent = `N√≠vel ${currentLevel + 1}/${session.levels.length}`;
            document.getElementById('levelTitle').textContent = level.title;
            document.getElementById('objective').textContent = level.objective;
            document.getElementById('hint').textContent = level.hint;
            document.getElementById('progressText').textContent = `Progresso Total: Sess√£o ${currentSession + 1}/4`;
            
            // Mostrar password do n√≠vel atual
            const passwordInput = document.getElementById('passwordInput');
            passwordInput.placeholder = `Password deste n√≠vel: ${level.password}`;

            // Progress bars
            const progressBars = document.getElementById('progressBars');
            progressBars.innerHTML = '';
            sessions.forEach((_, idx) => {
                const bar = document.createElement('div');
                bar.className = 'progress-segment';
                if (idx < currentSession) {
                    bar.style.background = '#48bb78';
                } else if (idx === currentSession) {
                    bar.style.background = '#8b5cf6';
                } else {
                    bar.style.background = '#4a5568';
                }
                progressBars.appendChild(bar);
            });
        }

        // üéÆ API DO HER√ìI
        function createHeroAPI() {
            const level = sessions[currentSession].levels[currentLevel];
            let pos = { ...level.start };
            const map = level.map;
            const localCollected = [];

            const canMove = (x, y) => {
                if (y < 0 || y >= map.length || x < 0 || x >= map[0].length) return false;
                if (map[y][x] === 1) return false; // Parede
                if (map[y][x] === 5 && !hasKey) return false; // Porta fechada
                return true;
            };

            return {
                direita: () => {
                    if (canMove(pos.x + 1, pos.y)) {
                        pos.x += 1;
                        playerPos = { ...pos };
                        addOutput(`‚û°Ô∏è Moveu para direita (${pos.x}, ${pos.y})`);
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o podes mover para direita! H√° uma parede.');
                        return false;
                    }
                },
                esquerda: () => {
                    if (canMove(pos.x - 1, pos.y)) {
                        pos.x -= 1;
                        playerPos = { ...pos };
                        addOutput(`‚¨ÖÔ∏è Moveu para esquerda (${pos.x}, ${pos.y})`);
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o podes mover para esquerda! H√° uma parede.');
                        return false;
                    }
                },
                cima: () => {
                    if (canMove(pos.x, pos.y - 1)) {
                        pos.y -= 1;
                        playerPos = { ...pos };
                        addOutput(`‚¨ÜÔ∏è Moveu para cima (${pos.x}, ${pos.y})`);
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o podes mover para cima! H√° uma parede.');
                        return false;
                    }
                },
                baixo: () => {
                    if (canMove(pos.x, pos.y + 1)) {
                        pos.y += 1;
                        playerPos = { ...pos };
                        addOutput(`‚¨áÔ∏è Moveu para baixo (${pos.x}, ${pos.y})`);
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o podes mover para baixo! H√° uma parede.');
                        return false;
                    }
                },
                coletar: () => {
                    const key = `${pos.x},${pos.y}`;
                    if (map[pos.y][pos.x] === 2 && !localCollected.includes(key) && !collected.includes(key)) {
                        localCollected.push(key);
                        collected.push(key);
                        addOutput('üíé Gema coletada!');
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o h√° nada para coletar aqui.');
                        return false;
                    }
                },
                pegar_chave: () => {
                    if (map[pos.y][pos.x] === 4 && !hasKey) {
                        hasKey = true;
                        addOutput('üîë Chave obtida!');
                        drawGame();
                        return true;
                    } else {
                        addOutput('‚ùå N√£o h√° chave aqui.');
                        return false;
                    }
                },
                tem_chave: () => {
                    return hasKey;
                },
                abrir_porta: () => {
                    if (map[pos.y][pos.x] === 5 && hasKey) {
                        addOutput('üö™ Porta aberta!');
                        drawGame();
                        return true;
                    } else if (map[pos.y][pos.x] === 5 && !hasKey) {
                        addOutput('üîí A porta est√° trancada! Precisas da chave.');
                        return false;
                    } else {
                        addOutput('‚ùå N√£o h√° porta aqui.');
                        return false;
                    }
                },
                ver_direita: () => {
                    const nextX = pos.x + 1;
                    if (map[pos.y]?.[nextX] === 3) return 'tesouro';
                    if (map[pos.y]?.[nextX] === 2) return 'gema';
                    if (map[pos.y]?.[nextX] === 4) return 'chave';
                    if (map[pos.y]?.[nextX] === 5) return 'porta';
                    if (map[pos.y]?.[nextX] === 1) return 'parede';
                    return 'vazio';
                },
                ver_esquerda: () => {
                    const nextX = pos.x - 1;
                    if (map[pos.y]?.[nextX] === 3) return 'tesouro';
                    if (map[pos.y]?.[nextX] === 2) return 'gema';
                    if (map[pos.y]?.[nextX] === 4) return 'chave';
                    if (map[pos.y]?.[nextX] === 5) return 'porta';
                    if (map[pos.y]?.[nextX] === 1) return 'parede';
                    return 'vazio';
                },
                ver_cima: () => {
                    const nextY = pos.y - 1;
                    if (map[nextY]?.[pos.x] === 3) return 'tesouro';
                    if (map[nextY]?.[pos.x] === 2) return 'gema';
                    if (map[nextY]?.[pos.x] === 4) return 'chave';
                    if (map[nextY]?.[pos.x] === 5) return 'porta';
                    if (map[nextY]?.[pos.x] === 1) return 'parede';
                    return 'vazio';
                },
                ver_baixo: () => {
                    const nextY = pos.y + 1;
                    if (map[nextY]?.[pos.x] === 3) return 'tesouro';
                    if (map[nextY]?.[pos.x] === 2) return 'gema';
                    if (map[nextY]?.[pos.x] === 4) return 'chave';
                    if (map[nextY]?.[pos.x] === 5) return 'porta';
                    if (map[nextY]?.[pos.x] === 1) return 'parede';
                    return 'vazio';
                },
                getPosition: () => pos
            };
        }

        // üíª EXECU√á√ÉO DE C√ìDIGO
        async function runCode() {
            if (isRunning) return;
            
            isRunning = true;
            document.getElementById('runBtn').disabled = true;
            document.getElementById('runBtn').innerHTML = '‚è≥ A Executar...';
            
            clearOutput();
            const level = sessions[currentSession].levels[currentLevel];
            playerPos = { ...level.start };
            collected = [];
            hasKey = false;
            drawGame();

            const code = document.getElementById('codeEditor').value;
            const heroi = createHeroAPI();

            try {
                const lines = code.split('\n');
                let functionDefs = {};
                let currentFunction = null;
                let functionBody = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.startsWith('#')) continue;

                    // Defini√ß√£o de fun√ß√£o
                    if (line.startsWith('def ')) {
                        const match = line.match(/def\s+(\w+)\s*\(\s*\):/);
                        if (match) {
                            currentFunction = match[1];
                            functionBody = [];
                            continue;
                        }
                    }

                    // Corpo da fun√ß√£o
                    if (currentFunction && lines[i].startsWith('    ')) {
                        functionBody.push(lines[i].substring(4));
                        continue;
                    }

                    // Finalizar fun√ß√£o
                    if (currentFunction && !lines[i].startsWith('    ')) {
                        functionDefs[currentFunction] = functionBody.join('\n');
                        currentFunction = null;
                        functionBody = [];
                    }

                    // Chamada de fun√ß√£o
                    if (functionDefs[line.replace('()', '')]) {
                        await executeLine(functionDefs[line.replace('()', '')], heroi, functionDefs);
                        continue;
                    }

                    // For loop
                    if (line.startsWith('for ')) {
                        const match = line.match(/for\s+\w+\s+in\s+range\((\d+)\):/);
                        if (match) {
                            const iterations = parseInt(match[1]);
                            let loopBody = [];
                            let j = i + 1;
                            while (j < lines.length && lines[j].startsWith('    ')) {
                                loopBody.push(lines[j].substring(4));
                                j++;
                            }

                            for (let k = 0; k < iterations; k++) {
                                for (const loopLine of loopBody) {
                                    await executeLine(loopLine, heroi, functionDefs);
                                    await sleep(300);
                                }
                            }
                            i = j - 1;
                            continue;
                        }
                    }

                    // If statement
                    if (line.startsWith('if ')) {
                        const condition = line.substring(3, line.length - 1);
                        const result = evalCondition(condition, heroi);

                        if (result) {
                            let j = i + 1;
                            while (j < lines.length && lines[j].startsWith('    ')) {
                                await executeLine(lines[j].substring(4), heroi, functionDefs);
                                await sleep(300);
                                j++;
                            }
                            i = j - 1;
                        }
                        continue;
                    }

                    await executeLine(line, heroi, functionDefs);
                    await sleep(300);
                }

                // Verificar vit√≥ria
                checkWin(heroi);

            } catch (error) {
                addOutput(`‚ùå Erro: ${error.message}`);
            }

            isRunning = false;
            document.getElementById('runBtn').disabled = false;
            document.getElementById('runBtn').innerHTML = '‚ñ∂Ô∏è Executar';
        }

        async function executeLine(line, heroi, functionDefs) {
            const trimmed = line.trim();

            if (functionDefs[trimmed.replace('()', '')]) {
                const funcCode = functionDefs[trimmed.replace('()', '')];
                const funcLines = funcCode.split('\n');
                for (const funcLine of funcLines) {
                    await executeLine(funcLine, heroi, functionDefs);
                    await sleep(300);
                }
                return;
            }

            if (trimmed.startsWith('heroi.')) {
                const method = trimmed.replace('heroi.', '').replace('()', '');
                if (heroi[method]) {
                    heroi[method]();
                }
            }
        }

        function evalCondition(condition, heroi) {
            try {
                const parts = condition.split('==').map(p => p.trim());
                if (parts.length === 2) {
                    const left = parts[0].includes('heroi.') ?
                        heroi[parts[0].replace('heroi.', '').replace('()', '')]() :
                        parts[0];
                    const right = parts[1].replace(/['"]/g, '');
                    return left === right;
                }
            } catch (e) {
                return false;
            }
            return false;
        }

        function checkWin(heroi) {
            const level = sessions[currentSession].levels[currentLevel];
            const finalPos = heroi.getPosition();
            const map = level.map;
            const reachedTreasure = map[finalPos.y][finalPos.x] === 3;
            const targetCollect = level.targetCollect || 0;
            const collectedEnough = collected.length >= targetCollect;

            if (reachedTreasure && collectedEnough) {
                // Verificar se √© o √öLTIMO n√≠vel de TODAS as sess√µes
                const isLastSession = currentSession === sessions.length - 1;
                const isLastLevel = currentLevel === sessions[currentSession].levels.length - 1;
                
                console.log('Vit√≥ria detectada!', {isLastSession, isLastLevel, currentSession, currentLevel});
                
                if (isLastSession && isLastLevel) {
                    // √öLTIMO N√çVEL! Grande celebra√ß√£o!
                    addOutput('üéâüèÜ PARAB√âNS! COMPLETASTE TODOS OS DESAFIOS! üèÜüéâ');
                    setTimeout(() => {
                        console.log('Lan√ßando celebra√ß√£o!');
                        celebrateVictory();
                    }, 1500);
                } else {
                    // N√≠vel normal - avan√ßar para o pr√≥ximo
                    addOutput('üéâ PARAB√âNS! N√≠vel completado!');
                    setTimeout(() => {
                        if (currentLevel < sessions[currentSession].levels.length - 1) {
                            currentLevel++;
                        } else if (currentSession < sessions.length - 1) {
                            currentSession++;
                            currentLevel = 0;
                        }
                        resetLevel();
                        updateUI();
                    }, 2000);
                }
            } else if (!reachedTreasure) {
                addOutput('‚ùå Ainda n√£o chegaste ao tesouro. Tenta de novo!');
            } else {
                addOutput(`‚ùå Precisas de coletar ${targetCollect} gemas!`);
            }
        }

        // üéâ CELEBRA√á√ÉO DE VIT√ìRIA FINAL
        function celebrateVictory() {
            console.log('üéâ celebrateVictory() chamada!');
            
            // Lan√ßar confetti!
            launchConfetti();
            
            // Mostrar modal
            console.log('Mostrando modal de vit√≥ria...');
            document.getElementById('victoryOverlay').classList.add('active');
            
            // Continuar lan√ßando confetti por 5 segundos
            const confettiInterval = setInterval(() => {
                launchConfetti();
            }, 400);
            
            setTimeout(() => {
                clearInterval(confettiInterval);
            }, 5000);
        }

        function launchConfetti() {
            // Verificar se biblioteca est√° carregada
            if (typeof confetti === 'undefined') {
                console.log('Confetti library not loaded, skipping confetti');
                return;
            }
            
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                const particleCount = 50 * (timeLeft / duration);
                
                confetti(Object.assign({}, defaults, { 
                    particleCount, 
                    origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
                }));
                confetti(Object.assign({}, defaults, { 
                    particleCount, 
                    origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
                }));
            }, 250);
        }

        function closeVictoryModal() {
            document.getElementById('victoryOverlay').classList.remove('active');
        }

        // üõ†Ô∏è FUN√á√ïES AUXILIARES
        function resetLevel() {
            const level = sessions[currentSession].levels[currentLevel];
            document.getElementById('codeEditor').value = '';
            clearOutput();
            playerPos = { ...level.start };
            collected = [];
            hasKey = false;
            drawGame();
        }

        function checkLevelPassword() {
            const input = document.getElementById('passwordInput');
            const password = input.value.toUpperCase().trim();
            
            if (!password) {
                alert('‚ùå Insere uma password!');
                return;
            }
            
            // Procurar password em todos os n√≠veis
            for (let s = 0; s < sessions.length; s++) {
                for (let l = 0; l < sessions[s].levels.length; l++) {
                    if (sessions[s].levels[l].password === password) {
                        // Password correta! Saltar para esse n√≠vel
                        currentSession = s;
                        currentLevel = l;
                        
                        // Reset do n√≠vel
                        resetLevel();
                        updateUI();
                        
                        // Feedback
                        const levelTitle = sessions[s].levels[l].title;
                        addOutput(`üéâ N√≠vel desbloqueado: ${levelTitle}!`);
                        input.value = '';
                        return;
                    }
                }
            }
            
            // Password incorreta
            alert('‚ùå Password incorreta. Pede ajuda ao professor!');
            input.value = '';
        }

        function toggleInstructions() {
            showInstr = !showInstr;
            const instructions = document.getElementById('instructions');
            const btnText = document.getElementById('btnText');
            
            if (showInstr) {
                instructions.classList.remove('hidden');
                btnText.textContent = 'Ocultar';
            } else {
                instructions.classList.add('hidden');
                btnText.textContent = 'Mostrar';
            }
        }

        function openTeacherGuide() {
            // Abre o gui√£o de professor numa nova janela
            window.open('aventura-python-PROFESSOR.html', '_blank', 'width=1400,height=900');
        }

        function addOutput(text) {
            const output = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.className = 'console-line';
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('consoleOutput').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // üöÄ INICIALIZA√á√ÉO
        window.onload = () => {
            updateUI();
            drawGame();
            
            // Permitir Enter na caixa de password
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkLevelPassword();
                }
            });
        };
    </script>
</body>
</html>
